@using kyfelib
@model ContentModel
@{
    ViewBag.Title = "Edit Content";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

@section scripts {
	<script type="text/javascript">
		var LOCALES = ["ru", "en", "es"];
		$(document).ready(function () {
			var apiUrl = "/api/edit";

			$('#langTab a:first').tab('show');

			$('.btn.delete').click(function(e) {
				$(this).attr("data");
			});

			function addArticleRow(item) {
				$("#articles tbody").append("<tr><td>" + item.Id + "</td><td>" + item.Name + "</td><td>" + item.Author +
					'</td><td><button class="btn edit" data="' + item.Id + '">Edit</button>' +
					'<button class="btn delete" data="' + item.Id + '">Delete</button></td></tr>');
			}

			function updateArticleRow(item) {

			}

			function articleGetList(page) {
				$.getJSON(apiUrl).done(function (data) {
					$.each(data, function (key, item) {
						addArticleRow(item);
					});
				});
			}

			function articleGet(id) {
				$.getJSON(apiUrl + '/' + id).done(function (data) {

				});
			}

			function articleCreate(data) {
				$.ajax({
					url: apiUrl,
					type: "POST",
					dataType: "json",
					data: data,
					error: function (jqXHR, textStatus, errorThrown) {
					},
					success: function (data, textStatus, jqXHR) {
						addArticleRow(data);
					}
				});
			}

			function articleUpdate(data) {
				$.ajax({
					url: apiUrl,
					type: "PUT",
					dataType: "json",
					data: data,
					error: function (jqXHR, textStatus, errorThrown) {
					},
					success: function (data, textStatus, jqXHR) {
						updateArticleRow(data);
					}
				});
			}

			function articleDelete(id) {
				$.ajax({
					url: apiUrl,
					type: "DELETE",
					dataType: "json",
					data: id,
					error: function (jqXHR, textStatus, errorThrown) {
					},
					success: function (data, textStatus, jqXHR) {
						if (data) {

						} else {

						}
					}
				});
			}

			function editFormClear() {
				$(':input[name="Name"]').val("");
				$(':input[name="Author"]').val("");
				$(':input[name="Text"]').val("");
				$(':input[name="Draft"]').checkOn();
			}
			
			$("#btnSave").click(function () {
				var aType = $('#editType .active').val();
				if (!aType) {
					$("#editType :button").addClass("btn-danger");
					return;
				}

				var newArticle = { "PartitionKey": aType, "Locales": [] };

				for (var i = 0; i < LOCALES.length; i++) {
					var aName = $.trim($('#' + LOCALES[i] + ' :input[name="Name"]').val());
					var aAuthor = $.trim($('#' + LOCALES[i] + ' :input[name="Author"]').val());
					var aText = $.trim($('#' + LOCALES[i] + ' :input[name="Text"]').val());
					var aDraft = $('#' + LOCALES[i] + ' :input[name="Draft"]:checked').length > 0;

					if (aName.length > 0 || aAuthor.length > 0 || aText.length > 0) {
						if (aName.length == 0) {
							$('#' + LOCALES[i] + ' :input[name="Name"]').addClass("error");
							break;
						}
						if (aAuthor.length == 0) {
							$('#' + LOCALES[i] + ' :input[name="Author"]').addClass("error");
							break;
						}
						if (aText.length == 0) {
							$('#' + LOCALES[i] + ' :input[name="Text"]').addClass("error");
							break;
						}

						newArticle.Locales.push({ "Name": aName, "Locale": LOCALES[i], "Text": aText, "Author": aAuthor, "Draft": aDraft });
					}
				}
				if (newArticle.Locales.length > 0)
					articleCreate(newArticle);
			});

			$("#editLanguage :button, #editType :button").click(function () {
				$("#editLanguage :button").removeClass("btn-danger");
			});
			$("#editType :button").click(function () {
				$("#editType :button").removeClass("btn-danger");
			});

			articleGetList(0);

			//$('#editForm').modal({ keyboard: false, hide: true });
			$("#editForm").hide();
		});
	</script>
}

<h2>Articles</h2>
<button class="btn" data-toggle="modal" data-target="#editForm">Add New</button>
<table id="articles" class="table table-striped table-hover">
	<thead>
		<tr>
			<th>Date</th>
			<th>Title</th>
			<th>Author</th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>
@Html.Partial("_EditForm")