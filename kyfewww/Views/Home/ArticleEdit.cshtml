@using kyfelib
@model Article
@{
	ViewBag.Title = "KYFE Articles";
}

@section scripts {
	<script type="text/javascript">
		var LOCALES = ["ru", "en", "es"];
		$(document).ready(function() {
			var apiUrl = "/api/edit";

			$('#langTab a:first').tab('show');

			function addArticleRow(item) {
				$("#articles tbody").append("<tr><td>" + item.RowKey + "</td><td>" + item.Name + "</td><td>" + item.Author + "</td></tr>");
			}

			function updateArticleRow(item) {

			}

			function articleGetList(page) {
				$.getJSON(apiUrl).done(function(data) {
					$.each(data, function(key, item) {
						addArticleRow(item);
					});
				});
			}

			function articleGet(id) {
				$.getJSON(apiUrl + '/' + id).done(function(data) {

				});
			}

			function articleCreate(data) {
				$.ajax({
					url: apiUrl,
					type: "POST",
					dataType: "json",
					data: data,
					error: function(jqXHR, textStatus, errorThrown) {
					},
					success: function(data, textStatus, jqXHR) {
						addArticleRow(data);
					}
				});
			}

			function articleUpdate(data) {
				$.ajax({
					url: apiUrl,
					type: "PUT",
					dataType: "json",
					data: data,
					error: function(jqXHR, textStatus, errorThrown) {
					},
					success: function(data, textStatus, jqXHR) {
						updateArticleRow(data);
					}
				});
			}

			function articleDelete(id) {
				$.ajax({
					url: apiUrl,
					type: "DELETE",
					dataType: "json",
					data: id,
					error: function(jqXHR, textStatus, errorThrown) {
					},
					success: function(data, textStatus, jqXHR) {
						if (data) {

						} else {

						}
					}
				});
			}

			$("#btnSave").click(function() {
				var aType = $('#editType .active').val();
				if (!aType) {
					$("#editType :button").addClass("btn-danger");
					return;
				}

				var newArticle = { "PartitionKey": aType, "Locales": [] };

				for (var i = 0; i < LOCALES.length;i++) {
					var aName = $.trim($('#' + LOCALES[i] + ' :input[name="Name"]').val());
					var aAuthor = $.trim($('#' + LOCALES[i] + ' :input[name="Author"]').val());
					var aText = $.trim($('#' + LOCALES[i] + ' :input[name="Text"]').val());
					var aDraft = $('#' + LOCALES[i] + ' :input[name="Draft"]:checked').length > 0;
					
					if (aName.length > 0 || aAuthor.length > 0 || aText.length > 0) {
						if (aName.length == 0) {
							$('#' + LOCALES[i] + ' :input[name="Name"]').addClass("error");
							break;
						}
						if (aAuthor.length == 0) {
							$('#' + LOCALES[i] + ' :input[name="Author"]').addClass("error");
							break;
						}
						if (aText.length == 0) {
							$('#' + LOCALES[i] + ' :input[name="Text"]').addClass("error");
							break;
						}

						newArticle.Locales.push({ "Name": aName, "Locale": LOCALES[i], "Text": aText, "Author": aAuthor, "Draft": aDraft });
					}
				}
				if (newArticle.Locales.length > 0)
					articleCreate(newArticle);
			});

			$("#editLanguage :button, #editType :button").click(function() {
				$("#editLanguage :button").removeClass("btn-danger");
			});
			$("#editType :button").click(function() {
				$("#editType :button").removeClass("btn-danger");
			});

			articleGetList(0);

			$('#editForm').modal({ keyboard: false, hide: true });
			$("#editForm").hide();
		});
	</script>
}

<div id="body">
	<section class="featured">
		<div class="content-wrapper">
			<h2>Articles</h2>
			<button class="btn" data-toggle="modal" data-target="#editForm">Add New</button>
			<table id="articles" class="table table-striped table-hover">
				<thead>
					<tr>
						<th>Date</th>
						<th>Title</th>
						<th>Author</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</section>
</div>

<!-- Edit Form -->
<div class="modal hide fade" id="editForm">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3>New article</h3>
	</div>
	<div class="modal-body">
		<p>
			<div class="btn-group" data-toggle="buttons-radio" id="editType">
				<button type="button" class="btn" name="Type" value="Article">Article</button>
				<button type="button" class="btn" name="Type" value="Meditation">Meditation</button>
				<button type="button" class="btn" name="Type" value="Kriya">Kriya</button>
			</div>
			<div class="article-edit">
				<ul class="nav nav-tabs" id="langTab">
					@foreach (string locale in Enum.GetNames(typeof(Locale)))
					{
						<li><a href="#@locale" data-toggle="tab"><strong>@locale</strong></a></li>
					}
				</ul>
			</div>
			<div class="tab-content">
				@foreach (string locale in Enum.GetNames(typeof (Locale)))
				{
					<div class="tab-pane" id="@locale">
						<label>Title&nbsp;<input type="text" class="input-xlarge" name="Name" /></label>
						<label>Author&nbsp;<input type="text" class="input-xlarge" name="Author" /></label>
						<label>Text<textarea name="Text" rows="5"></textarea></label>
						<label class="checkbox"><input type="checkbox" name="Draft">Draft</label>
					</div>
				}
			</div>			
		</p>
	</div>
	<div class="modal-footer">
		<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
		<button class="btn btn-primary" id="btnSave">Save changes</button>
	</div>
</div>
<!-- [Edit Form] -->

<!-- 
	TODO:
	1. Сделать метку черновика для материала.
-->